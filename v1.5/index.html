<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>iconfont-doc</title>
  <style>
    .main {
      max-width: 880px;
      margin: 0 auto;
    }

    .title {
      text-align: center;
    }

    .prefix-cont {
      font-size: 20px;
    }

    .list {
      padding: 0;
    }

    .list li {
      list-style: none;
      display: inline-block;
      width: 100px;
      height: 110px;
      text-align: center;
      margin: 2px;
      overflow: hidden;
    }

    .icon-name {
      margin-top: 14px;
      font-size: 12px;
    }

    .iconfont {
      font-size: 42px;
      color: #555;
    }
  </style>
</head>
<body>
  <input id="IconfontFile" type="file" accept=".ttf,.woff,.otf">
  <!-- <section class="main">
    <h1 class="title">Iconfont列表</h1>
    <p class="prefix-cont">
      Iconfont 前缀: <span id="IconfontPrefix"></span>
    </p>
    <span onclick="doSave()">download</span>
    <section>
      <ul id="IconfontList" class="list">
      </ul>
    </section>
  </section> -->
</body>

<script>
  // 载入opentype
  var $opentype = document.createElement('script');
  $opentype.src = 'https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js';
  document.head.append($opentype);

  // 写入
  var $section = document.createElement('section');
  $section.className = 'main';
  $section.innerHTML = `
    <h1 class="title">Iconfont列表</h1>
    <p class="prefix-cont">
      Iconfont 前缀: <span id="IconfontPrefix"></span>
    </p>
    <span onclick="doSave()">download</span>
    <section>
      <ul id="IconfontList" class="list">
      </ul>
    </section>
  `;
  document.body.append($section);


  // 获取节点
  var $ = function (note) {
    return document.querySelector(note)
  }

  var prefix = 'icon'
  // icon项html模版
  var getIconItemHtml = function(prefix, iconName, value) {
    return `
    <li>
      <span class="${prefix} icon-${iconName}" alt="\\${value}"></span>
      <div class="icon-name">icon-${iconName}</div>
    </li>`;
  };
  // icon项样式模版
  function getFontFace(url) {
    return `
      @font-face {
        font-family: 'iconfont';
        src: url('${url}') format('truetype');
      }

      .iconfont {
        font-family: "iconfont" !important;
        font-size: 32px;
        font-style: normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }`;
  };
  // icon项样式
  function getIconCss(name, value) {
    return `
      .icon-${name}:before {
        content: "\\${value}";
      }`;
  };

  // 获取目标对象
  var $input = $('#IconfontFile');
  var $iconfontList = $('#IconfontList');

  // 文件选择处理
  $input.addEventListener('change', getLocalFontFile, false)

  // 获取本地字体文件
  function getLocalFontFile(ent) {
    let file = ent.target.files[0];
    let reader = new FileReader();
    let icons = null;

    // 文件加载
    reader.readAsArrayBuffer(file);
    reader.onload = (e) => {
      icons = parseIcons(e.target.result);
      // 设置html代码
      let htmltpl = getIconHtml(icons.prefix, icons.icons);
      $iconfontList.innerHTML = htmltpl;
    }

    // base64 编码，动态加入 @font-face
    let readerBase64 = new FileReader();
    readerBase64.readAsDataURL(file);
    readerBase64.onload = (e) => {
      let $style = document.createElement('style');
      let fontFace = getFontFace(e.target.result);
      let iconCss = '';
      icons.icons.forEach(iconItem => {
        iconCss += getIconCss(iconItem.name, iconItem.value);
      });
      $style.innerHTML = fontFace + iconCss;
      document.body.append($style);
    }
  };

  // 解析icon
  function parseIcons(bufferStr, uniqueID = 'iconfont') {
    let iconList = [];
    let result = window.opentype.parse(bufferStr);
    prefix = result.names.uniqueID.en || uniqueID;

    for (let key in result.glyphs.glyphs) {
      let item = result.glyphs.glyphs[key];
      if (!item.unicode) {
        continue
      } else {
        iconList.push({
          name: item.name,
          value: parseInt(item.unicode).toString(16)
        });
      }
    }

    return {
      prefix,
      icons: iconList
    };
  };


  // 获取完整html
  function getIconHtml(prefix, iconList = []) {
    var allHtml = '';
    if (!Array.isArray(iconList)) {
      allHtml = '没有正确生成icon';
      return allHtml;
    }

    iconList.forEach(e => {
      allHtml += getIconItemHtml(prefix, e.name, e.value);
    });

    return allHtml;
  };

  // 保存
  function doSave(downUrl, fileName = 'icon-docs.html') {
    let a = document.createElement('a');
    downUrl = downUrl || window.location.href;
    a.download = fileName;
    document.body.appendChild(a);
    a.href = downUrl;
    a.target = '_parent';
    a.click();
    a.remove();
  };

</script>
</html>
