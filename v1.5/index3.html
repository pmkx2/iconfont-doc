<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>iconfont-doc</title>
</head>
<body>
</body>

<script>
  // 获取节点
  var $ = function (note) {
    return document.querySelector(note)
  }

  // 获取区间html代码
  var getSection = function (htmlTpl, start, end) {
    var symbol = '<!-->\\/{}[]`~@#$%^&*()_+-=|,.?:;"\''.split('');
    if (!htmlTpl || htmlTpl === '') return htmlTpl;
    if ((!start || start === '') || (!end || end === '')) return '';

    var newStart = []
    for (let i = 0; i < start.length; i++) {
      var t = start[i]
      for (let i2 = 0; i2 < symbol.length; i2++) {
        if (t === symbol[i2]) {
          t = '\\' + t;
          break;
        }
      }
      newStart.push(t)
    }

    var newEnd = []
    for (let i = 0; i < end.length; i++) {
      var t = end[i]
      for (let i2 = 0; i2 < symbol.length; i2++) {
        if (t === symbol[i2]) {
          t = '\\' + t;
          break;
        }
      }
      newEnd.push(t)
    }

    eval('var reg = /(?<=' + newStart.join('') +')([^\^]+)(?=' + newEnd.join('') + ')/gim;')
    return (htmlTpl.match(reg)).join()
  }

  var iconDoc = {
    // 下载时的文件名称
    fileName: 'icon-docs.html',
    // 模版代码
    tpl: {
      htmlTpl:`
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>iconfont-doc</title>
    <style>
      .main {
        max-width: 880px;
        margin: 0 auto;
      }
      .title {
        text-align: center;
      }
      .prefix-cont {
        font-size: 20px;
      }
      .list {
        padding: 0;
      }
      .list li {
        list-style: none;
        display: inline-block;
        width: 100px;
        height: 110px;
        text-align: center;
        margin: 2px;
        overflow: hidden;
      }
      .icon-name {
        margin-top: 14px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <section class="main">
      <!--input-->
      <input id="IconfontFile" type="file" accept=".ttf,.woff,.otf"/>
      <!--/input-->

      <h1 class="title">Iconfont列表</h1>

      <!--
      <p class="prefix-cont">
        Iconfont 前缀: <span id="IconfontPrefix"></span>
      </p>
      -->

      <!--download-->
      <span id="IconfontDownload">download</span>
      <!--/download-->

      <section>
        <ul id="IconfontList" class="list">
          <!--item-->
          <li>
            <span class="{{prefix}} {{iconName}}"></span>
            <div class="icon-name">{{iconName}}</div>
          </li>
          <!--/item-->
        </ul>
      </section>
    </section>
  </body>
</html>
    `
    }
  };

  // 字体文件解释库
  iconDoc.opentypeUrl = 'https://cdn.jsdelivr.net/npm/opentype.js@latest/dist/opentype.min.js';
  iconDoc.prefix = 'icon'

  // 获取head与body标签对象
  iconDoc.$head = $('head');       // head
  iconDoc.$body = $('body');       // body
  iconDoc.$iconfontList = null;    // iconfontList

  // 清除无用代码
  iconDoc.removeUseless = function (htmlTpl) {
    var inputHtml = getSection(this.tpl.htmlTpl, 'input-->', '<!--/input')
    var downloadHtml = getSection(this.tpl.htmlTpl, 'download-->', '<!--/download')
    return htmlTpl.replace(inputHtml, '').replace(downloadHtml, '');
  }

  // 初始化html
  iconDoc.initHtml = function () {
    // 从html模版中截取对应的代码
    this.tpl.headHtml = getSection(this.tpl.htmlTpl, 'head>', '</head'),
    this.tpl.bodyHtml = getSection(this.tpl.htmlTpl, 'body>', '</body'),
    this.tpl.iconItemHtml = getSection(this.tpl.htmlTpl, 'item-->', '<!--/item')
    // 清除循环用的代码
    this.tpl.bodyHtml = this.tpl.bodyHtml.replace(this.tpl.iconItemHtml, '');
    // 往页面写入html代码
    this.$head.innerHTML = this.tpl.headHtml;
    this.$body.innerHTML = this.tpl.bodyHtml;
    return 'init html done'
  }

  // 初始化script
  iconDoc.initScript = function () {
    // 载入opentype
    var $opentype = document.createElement('script');
    $opentype.src = this.opentypeUrl;
    document.body.append($opentype);
    return 'init script done'
  }

  // 初始化input
  iconDoc.initInput = function () {
    // 获取input
    this.$input = $('#IconfontFile');
    this.$input.addEventListener('change', this.getLocalFontFile, false);
    this.$iconfontList = $('#IconfontList');
    return 'init input done'
  }

  // 初始化下载
  iconDoc.initDownload = function () {
    // 获取input
    this.$input = $('#IconfontDownload');
    this.$input.addEventListener('click', this.doSaveHtml, false);
    return 'init download done'
  }

  // 获取本地字体文件
  iconDoc.getLocalFontFile = function(ent) {
    let file = ent.target.files[0];
    let reader = new FileReader();
    let icons = null;

    // 文件加载
    reader.readAsArrayBuffer(file);
    reader.onload = (e) => {
      icons = iconDoc.parseIcons(e.target.result);
      // 设置html代码
      let iconsHtml = iconDoc.getIconHtml(icons.prefix, icons.icons);
      iconDoc.$iconfontList.innerHTML = iconsHtml;
    }

    // base64
    let readerBase64 = new FileReader();
    readerBase64.readAsDataURL(file);
    readerBase64.onload = (e) => {
      let $style = document.createElement('style');
      let fontFace = iconDoc.getFontFace(e.target.result);
      let iconCss = '';
      icons.icons.forEach(iconItem => {
        iconCss += iconDoc.getIconCss(iconItem.name, iconItem.value);
      });
      $style.innerHTML = fontFace + iconCss;
      document.head.append($style);
    }
  };

  // 解析icon
  iconDoc.parseIcons = function(bufferStr, uniqueID = 'iconfont') {
    let iconList = [];
    let result = window.opentype.parse(bufferStr);
    prefix = result.names.uniqueID.en || uniqueID;

    for (let key in result.glyphs.glyphs) {
      let item = result.glyphs.glyphs[key];
      if (!item.unicode) {
        continue
      } else {
        iconList.push({
          name: item.name,
          value: parseInt(item.unicode).toString(16)
        });
      }
    }

    return {
      prefix,
      icons: iconList
    };
  };

  // 获取完整html
  iconDoc.getIconHtml = function(prefix, iconList = []) {
    var allHtml = '';
    if (!Array.isArray(iconList)) {
      allHtml = '没有正确生成icon';
      return allHtml;
    }

    iconList.forEach(e => {
      allHtml += this.tpl.iconItemHtml
            .replace('{{prefix}}', prefix)         // 置换模版内的icon前缀
            .replace(/\{\{iconName\}\}/g, `${iconDoc.prefix}-${e.name}`)  // 置换模版内的icon名称
    });

    return allHtml;
  };

  // icon项样式模版
  iconDoc.getFontFace = function(url) {
    return `
      @font-face {
        font-family: 'iconfont';
        src: url('${url}') format('truetype');
      }

      .iconfont {
        font-family: "iconfont" !important;
        font-size: 32px;
        font-style: normal;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }`;
  };
  // icon项样式
  iconDoc.getIconCss = function(name, value) {
    return `
      .icon-${name}:before {
        content: "\\${value}";
      }`;
  };

  // 保存
  iconDoc.doSaveHtml = function(target) {
    var htmlText = iconDoc.tpl.htmlTpl
        .replace(iconDoc.tpl.headHtml, iconDoc.$head.innerHTML)
        .replace(iconDoc.tpl.iconItemHtml, iconDoc.$iconfontList.innerHTML)
    htmlText = iconDoc.removeUseless(htmlText)
    // console.log(htmlText)

    let $a = document.createElement('a');
    document.body.appendChild($a);

    $a.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlText);
    $a.download = iconDoc.fileName;
    $a.target = '_parent';
    $a.click();
    $a.remove();
  };

  // 初始化代码配置
  iconDoc.init = function () {
    iconDoc.initHtml()
    iconDoc.initScript()
    iconDoc.initInput()
    iconDoc.initDownload()
  }

  iconDoc.init()
</script>
</html>
